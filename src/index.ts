import * as fs from 'fs';
import * as path from 'path';
import { GraphQLSchema } from 'graphql';
import { GenerateTypescriptOptions, defaultOptions } from './types';
import { TypeScriptGenerator } from './typescriptGenerator';

const packageJson = require(path.join(__dirname, '../package.json'));

export const generateTypeScriptTypes = async (schema: GraphQLSchema, outputPath: string, options: GenerateTypescriptOptions = defaultOptions) => {
    const mergedOptions = { ...defaultOptions, ...options };
    const tsGenerator = new TypeScriptGenerator(mergedOptions);
    const typeDefs = await tsGenerator.generate(schema);

    const jsDoc =
        `/**
 * This file is auto-generated by ${packageJson.name}@${packageJson.version}
 * Please note that any changes in this file may be overwritten
 */
`;

    let body: string[] = [...typeDefs];

    if (mergedOptions.namespace) {
        body = [
            `namespace ${options.namespace} {`,
            ...body.map(line => ' '.repeat(mergedOptions.tabSpaces) + line),            
            '}'
        ];
    }

    if (mergedOptions.global) {
        body = [
            'export { };',
            '',
            'declare global {',
            ...body.map(line => ' '.repeat(mergedOptions.tabSpaces) + line),
            '}'
        ];
    }

    fs.writeFileSync(outputPath, [jsDoc, ...body].join('\n'), 'utf-8');
};